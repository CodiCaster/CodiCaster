<html layout:decorate="~{usr/layout/layout.html}">
<head>
    <title>ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>

<main layout:fragment="main" class="flex-grow flex items-center justify-center">
    <div class="max-w-2xl w-full px-4">
        <h1 class="mb-4">
            <i class="fa-solid fa-magnifying-glass"></i>
            ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°
        </h1>
        <div class="flex flex-col gap-4">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title flex justify-center items-center">
                        <span th:text="${article.title}" class="text-4xl"></span>
                    </h2>
                    <hr style="border: none; border-top: 1px solid rgba(0, 0, 0, 0.2); box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2);">
                    <br>
                    <div class="article-detail">
                        <div class="user-info-location-weather">
                            <!-- ì‚¬ìš©ì ì •ë³´ ì˜ì—­ -->
                            <div class="user-info flex items-start justify-between">
                                <div class="flex items-center">
                                    <!--í”„ë¡œí•„ ëŒ€ì‹  ì•„ì´ì½˜ìœ¼ë¡œ ì„ì‹œ ëŒ€ì²´-->
                                    <div>
                                        <i class="fa-solid fa-circle-user fa-2xl"></i>
                                    </div>
                                    <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
                                    <!-- <div class="profile-pic mr-2">
                                        <img src="/images/default-profile-pic.png" alt="User Image" class="w-24 h-24" />
                                    </div> -->
                                    <!-- ì‚¬ìš©ì ì´ë¦„ ë° ìƒì„± ì‹œê°„ -->
                                    <div class="flex flex-col ml-2">
                                        <div class="username text-lg font-bold">
                                            <div class="username text-lg font-bold">
                                                <div style="display: inline-block;">
                                                    <span th:text="${article.author.nickname}"></span>
                                                </div>
                                                <div style="display: inline-block;">
                                                    <form th:if="${@rq.isFollowed(article.author)}" th:action="@{'/usr/unfollow/' + ${article.id}}" method="post" style="display: inline;">
                                                        <button type="submit" class="btn btn-active">íŒ”ë¡œì‰</button>
                                                    </form>
                                                    <form th:unless="${@rq.isFollowed(article.author)}" th:action="@{'/usr/follow/' + ${article.id}}" method="post" style="display: inline;">
                                                        <button type="submit" class="btn btn-info">íŒ”ë¡œìš°</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="create-datetime text-sm text-gray-600">
                                            <span th:text="${#temporals.format(article.createDate, 'yyyy-MM-dd HH:mm:ss')}"></span>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <div class="badge badge-ghost text-right">
                                        <span th:text="${article.address}"></span>
                                    </div>
                                    <div class="text-right">
                                        <span class="badge badge-ghost" th:text="${@rq.getWeatherInfo}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- ê²Œì‹œê¸€ ë‚´ìš© ì˜ì—­ -->
                        <div class="article-content text-center">
                            <!-- ê²Œì‹œê¸€ ì´ë¯¸ì§€ -->
                            <div class="article-image relative flex justify-center items-center"
                                 style="padding-top: 5%;">
                                <img th:src="${article.image != null ? article.image.filepath : '/images/default.png'}"
                                     alt="Article Image" class="object-scale-down"/>
                            </div>

                            <!-- ë‚´ìš© -->
                            <div class="content text-base" style="padding-top: 5%; word-wrap: break-word; word-break: break-all;">
                                <span th:text="${article.content}"></span>
                            </div>

                        </div>

                        <!-- ìƒí˜¸ì‘ìš© ì˜ì—­ (ì¢‹ì•„ìš”) -->
                        <div class="like">
                            <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
                            <button id="like-button" class="heart-icon text-red-500 mr-1">
                                <!-- ì¢‹ì•„ìš” ìƒíƒœì— ë”°ë¼ ì•„ì´ì½˜ ë³€ê²½ -->
                                <span th:if="${isLiked}">ğŸ’•</span>
                                <span th:unless="${isLiked}">ğŸ¤</span>
                            </button>
                            <!-- ì¢‹ì•„ìš” ìˆ˜ -->
                            <span id="like-count"
                                  th:text="${article.getLikedMembers().size() != null ? article.getLikedMembers().size() : 0}">0</span>
                        </div>


                        <div class="back-to-list mt-4 flex justify-end">
                            <!-- ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
                            <a href="/usr/article/list" class="btn btn-primary mr-4">ëª©ë¡ìœ¼ë¡œ</a>
                            <!-- ìˆ˜ì • ë²„íŠ¼ -->
                            <a href="usr/article/modify/{id}" th:href="@{/usr/article/modify/{id}(id=${article.id})}"
                               class="btn btn-warning">ìˆ˜ì •</a>
                            <!-- ì‚­ì œ ë²„íŠ¼ -->
                            <a href="usr/article/delete/{id}" th:href="@{/usr/article/delete/{id}(id=${article.id})}"
                               class="btn btn-danger ml-4" onclick="return confirmDelete()">ì‚­ì œ</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        function confirmDelete() {
            return confirm("ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"); // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ ëŒ€í™”ìƒìë¥¼ í‘œì‹œ
        }

        $(document).ready(function () {
            // ì¢‹ì•„ìš” ìƒíƒœ
            let isLiked = /*[[${isLiked}]]*/ null;
            console.log(isLiked)

            // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
            $('#like-button').click(function () {
                // ì¢‹ì•„ìš” ìƒíƒœ ë³€ê²½
                isLiked = !isLiked;

                // ì¢‹ì•„ìš” ìƒíƒœì— ë”°ë¼ ìš”ì²­ URL ë³€ê²½
                let url = isLiked ? '/usr/article/like/' : '/usr/article/unlike/';

                // ì¢‹ì•„ìš” ìˆ˜
                let likeCount = parseInt($('#like-count').text());

                let id = /*[[${article.id}]]*/ null;
                console.log(id)
                var csrfToken = $("meta[name='_csrf']").attr("content");
                var csrfHeader = $("meta[name='_csrf_header']").attr("content");
                $.ajax({
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    url: url + id,  // ê²Œì‹œê¸€ IDë¥¼ URLì— í¬í•¨
                    type: 'POST',
                    headers: { // í—¤ë” ì„¤ì • ë³€ê²½
                        [csrfHeader]: csrfToken // ì˜¬ë°”ë¥¸ í—¤ë” ì„¤ì •
                    },
                    success: function (response) {
                        // ì¢‹ì•„ìš” ìƒíƒœì— ë”°ë¼ ì¢‹ì•„ìš” ìˆ˜ ë³€ê²½
                        $('#like-count').text(isLiked ? likeCount + 1 : likeCount - 1);

                        // ì¢‹ì•„ìš” ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ ì•„ì´ì½˜ ë³€ê²½
                        $('#like-button').html(isLiked ? 'ğŸ’•' : 'ğŸ¤');
                    },
                    error: function (error) {
                        // ì—ëŸ¬ ì²˜ë¦¬
                        console.error(error);
                    }
                });
            });
        });
    </script>
</main>
</body>
</html>
