<html layout:decorate="~{usr/layout/layout.html}">
<head>
    <title>ê´€ì‹¬ ê²Œì‹œê¸€ ëª©ë¡</title>
</head>
<body>
<main layout:fragment="main" class="flex-grow flex items-center justify-center">
    <div class="max-w-2xl w-full px-4">
        <h1 class="mb-4">
            <i class="fa-solid fa-people-arrows"></i> ê´€ì‹¬ ê²Œì‹œë¬¼
        </h1>
        <div>
        </div>
        <div class="flex flex-col gap-4">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <section th:fragment="articleListFragment" class="justify-center"
                             th:if="${not #lists.isEmpty(articleList)}">
                        <div id="articleList">
                            <div th:if="${@rq.isLogin()}">
                                <div th:each="article : ${articleList}"
                                     class="rounded overflow-hidden shadow-lg px-4 py-6 my-4">
                                    <a th:href="@{/usr/article/detail/{id}(id=${article.id})}">
                                        <div class="flex justify-start ml-6 my-4"
                                             th:text="${article.getAuthor().nickname}"></div>
                                        <img th:src="${article.image != null ? article.image.filepath : '/images/default.png'}"
                                             class="w-30 object-contain"/>
                                        <div class="px-6 py-4 flex flex-col">
                                            <div class="flex justify-center font-bold text-xl mb-2 truncate"
                                                 th:text="${article.title}"></div>
                                            <div class="flex justify-end mr-4">
                                                <div class="like-display badge badge-lg">
                                                    <span class="heart-icon text-red-500 mr-1">ğŸ’•</span>
                                                    <span th:text="${article.getLikedMembers().size()}"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        var page = 0;
        var size = 5;
        var hasNextPage = [[${articleList.hasNext()}]];
        var loading = false; // ë™ì‹œì— ì—¬ëŸ¬ ê°œì˜ ìš”ì²­ì„ ë°©ì§€í•˜ê¸° ìœ„í•œ í”Œë˜ê·¸

        function loadMoreArticles() {
            if (hasNextPage && !loading) {
                page++;
                loading = true; // ë¡œë”© ì¤‘ì„ì„ ë‚˜íƒ€ë‚´ëŠ” í”Œë˜ê·¸ë¥¼ trueë¡œ ì„¤ì •

                $.ajax({
                    url: "/usr/article/follow/list",
                    method: "GET",
                    data: {page: page, size: size},
                    success: function (data) {
                        // ìš”ì²­ì´ ì„±ê³µí–ˆì„ ë•Œ ì‹¤í–‰í•  ë¡œì§
                        if (data.trim().length > 0) {
                            $("#articleList").append(data);
                            hasNextPage = true;
                        } else {
                            hasNextPage = false;
                            // ë” ì´ìƒ ê²Œì‹œë¬¼ì´ ì—†ìŒì„ í‘œì‹œí•˜ëŠ” ë¡œì§ ì¶”ê°€
                            $("#articleList").append("<p>ë” ì´ìƒ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>");
                        }

                        loading = false; // ë¡œë”© ì™„ë£Œ
                    },
                    //500ì—ëŸ¬ ëœ¨ë©´ ì—¬ê¸°ë¡œ ì˜´.
                    error: function (error) {
                        // ìš”ì²­ì´ ì‹¤íŒ¨í–ˆì„ ë•Œ ì‹¤í–‰í•  ë¡œì§
                        console.log("AJAX ìš”ì²­ ì‹¤íŒ¨:", error);
                        hasNextPage = false;
                        loading = false; // ë¡œë”© ì™„ë£Œ
                        $("#articleList").append("<div class='flex flex-col text-2xl justify-center items-center mt-4'> ë¦¬ìŠ¤íŠ¸ì˜ ëì…ë‹ˆë‹¤. " +
                            "<div class='text-2xl my-4'> ë” ë§ì€ ê²Œì‹œë¬¼ì„ í™•ì¸í•˜ì„¸ìš”! </div>" +
                            "<div class=\"mt-4\">\n" +
                            "                            <a href=\"/usr/article/list\">\n" +
                            "                                <button class=\"btn btn-primary\">ì „ì²´ ê²Œì‹œë¬¼</button>\n" +
                            "                            </a>\n" +
                            "                        </div>" +
                            "" +
                            "</div>");
                    }
                });
            }
        }

        $(window).scroll(function () {
            if ($(window).scrollTop() + $(window).height() >= $(document).height()) {
                loadMoreArticles();
            }
        });


    </script>
</main>
</body>
</html>